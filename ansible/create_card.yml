---
- name: Create and burn card
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Create card in API
      include_role:
        name: api

    - name: Burn card to hardware
      block:
        - name: Write card firmware
          include_role:
            name: writter
            
        - name: Display success message
          debug:
            msg: |
              Card successfully created.
              ID: {{ card_id }}
              Status: waiting_pin

      rescue:
        - name: Display error message
          debug:
            msg: "Error during card burning, rolling back..."

        - name: Delete card from API
          include_tasks: roles/api/tasks/delete.yml

        - name: Fail playbook
          fail:
            msg: "Card creation failed and was rolled back"
