---
- name: Create and burn card
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Create card in API
      include_role:
        name: api

    - name: Burn card to hardware
      block:
        - name: Write card firmware
          include_role:
            name: writter

        - name: Update card status to active
          uri:
            url: "{{ api_url }}/v1/card/{{ card_id }}"
            method: PATCH
            body_format: json
            body:
              status: "active"
            status_code: 200

        - name: Display success message
          debug:
            msg: |
              âœ“ Card successfully created and burned!
              Card ID: {{ card_id }}
              Status: active

      rescue:
        - name: Display error message
          debug:
            msg: "Error during card burning, rolling back..."

        - name: Delete card from API
          include_tasks: roles/api/tasks/delete.yml

        - name: Fail playbook
          fail:
            msg: "Card creation failed and was rolled back"
