---
- name: Verify card_id is defined
  fail:
    msg: "card_id must be defined before assignment"
  when: card_id is not defined

- name: Build assignator software
  make:
    chdir: "{{ assign_folder }}"
  register: build_result

- name: Assign card ID to hardware
  command:
    cmd: "./assign {{ card_id }}"
    chdir: "{{ assign_folder }}"
  register: assign_result

- name: Display assignment output
  debug:
    msg: "{{ assign_result.stdout_lines }}"

- name: Verify assignment succeeded
  fail:
    msg: "Card ID assignment failed"
  when: assign_result.rc != 0

- name: Extract PUK from output
  set_fact:
    card_puk: "{{ assign_result.stdout | regex_search('Generated PUK: (\\d{4})', '\\1') | first }}"

- name: Extract public key from output
  set_fact:
    card_public_key: "{{ assign_result.stdout | regex_search('Card key \\(hex\\): ([0-9a-fA-F]{8})', '\\1') | first }}"

- name: Display extracted values for debugging
  debug:
    msg:
      - "PUK: {{ card_puk }}"
      - "Public Key: {{ card_public_key }}"

- name: Update card with PUK and public key in API
  uri:
    url: "{{ api_url }}/v1/card/{{ card_id }}"
    method: PATCH
    headers:
      Content-Type: "application/json"
      Authorization: "Bearer {{ api_token }}"
    body_format: json
    body:
      puk: "{{ card_puk }}"
      public_key: "{{ card_public_key }}"
    status_code: 200
  register: update_result

- name: Display assignment result
  debug:
    msg: "Card ID {{ card_id }} successfully assigned to hardware with PUK: {{ card_puk }}"
