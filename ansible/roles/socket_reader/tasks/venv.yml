---
- name: Check Python 3 is available
  command: python3 --version
  register: python_version
  changed_when: false
  failed_when: python_version.rc != 0

- name: Display Python version
  debug:
    msg: "Using {{ python_version.stdout }}"

- name: Create Python virtual environment
  command: python3 -m venv {{ venv_path }}
  args:
    creates: "{{ venv_path }}/bin/activate"

- name: Upgrade pip in virtual environment
  pip:
    name: pip
    state: latest
    virtualenv: "{{ venv_path }}"

- name: Check requirements.txt modification time
  stat:
    path: "{{ requirements_file }}"
  register: requirements_stat

- name: Check requirements marker file
  stat:
    path: "{{ venv_path }}/.requirements_installed"
  register: marker_stat

- name: Install Python dependencies
  pip:
    requirements: "{{ requirements_file }}"
    virtualenv: "{{ venv_path }}"
  register: dependencies_installed
  when: >
    not marker_stat.stat.exists or
    requirements_stat.stat.mtime > marker_stat.stat.mtime

- name: Update marker file
  file:
    path: "{{ venv_path }}/.requirements_installed"
    state: touch
    modification_time: preserve
    access_time: preserve
  when: dependencies_installed.changed

- name: Display dependency status
  debug:
    msg: "{{ 'Dependencies installed successfully' if dependencies_installed.changed else 'Dependencies up to date (skipped)' }}"
