---
- name: Create card in API and assign to card
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Create and assign card
      block:
        - name: Create card in API
          include_role:
            name: api

        - name: Assign card ID to card
          include_role:
            name: assigner

        - name: Display success message
          debug:
            msg: |
              Card successfully created and assigned.
              ID: {{ card_id }}
              Status: waiting_pin

      rescue:
        - name: Display error message
          debug:
            msg: "Error during card assignment, rolling back..."

        - name: Delete card from API if created
          include_tasks: roles/api/tasks/delete.yml
          when: card_id is defined

        - name: Fail playbook
          fail:
            msg: "Card assignment failed and was rolled back"
